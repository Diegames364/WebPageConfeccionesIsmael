{% extends "base/base.html" %}
{% block content %}
<div class="bg-white rounded-4 shadow-sm p-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h2 class="mb-0">Carrito</h2>

    <form method="post" action="{% url 'cart:clear' %}">
      {% csrf_token %}
      <button class="btn btn-outline-danger btn-pill" type="submit">
        Vaciar carrito
      </button>
    </form>
  </div>

  <hr class="my-3">

  {% if items %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Producto</th>
            <th style="width: 220px;">Cantidad</th>
            <th class="text-end">Total</th>
            <th style="width: 100px;"></th>
          </tr>
        </thead>
        <tbody id="cartTbody">
          {% for it in items %}
          <tr data-item-id="{{ it.id }}">
            <td>
              <div class="fw-semibold">{{ it.variant.product.name }}</div>
              <div class="text-muted small">
                {% for a in it.variant.attributes.all %}
                  <span class="me-2">{{ a.name }}: {{ a.value }}</span>
                {% endfor %}
              </div>
              <div class="text-muted small">Stock: <span class="stock">{{ it.variant.stock }}</span></div>
            </td>

            <td>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-dark btn-sm btn-pill btn-qty"
                        type="button"
                        data-delta="-1">
                  <i class="bi bi-dash"></i>
                </button>

                <input class="form-control form-control-sm text-center qty"
                       style="max-width: 70px;"
                       value="{{ it.quantity }}"
                       inputmode="numeric"
                       pattern="[0-9]*">

                <button class="btn btn-outline-dark btn-sm btn-pill btn-qty"
                        type="button"
                        data-delta="1">
                  <i class="bi bi-plus"></i>
                </button>
              </div>
              <div class="text-danger small mt-1 d-none err"></div>
            </td>

            <td class="text-end">
              $<span class="item-total">{{ it.total }}</span>
            </td>

            <td class="text-end">
              <form method="post" action="{% url 'cart:remove' it.id %}">
                {% csrf_token %}
                <button class="btn btn-outline-danger btn-sm btn-pill" type="submit">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-end">
      <div class="bg-light rounded-4 p-3" style="min-width: 280px;">
        <div class="d-flex justify-content-between">
          <span>Subtotal</span>
          <strong>$<span id="cartSubtotal">{{ cart.subtotal }}</span></strong>
        </div>

        <div class="d-grid mt-3">
          <a class="btn btn-dark btn-pill" href="{% url 'orders:checkout' %}" id="btnCheckout">
            Ir al checkout
          </a>
        </div>

        <div class="d-grid mt-2">
          <a class="btn btn-outline-dark btn-pill" href="{% url 'catalog:list' %}">
            Seguir comprando
          </a>
        </div>
      </div>
    </div>

  {% else %}
    <div class="text-muted">Tu carrito está vacío.</div>
    <div class="mt-3">
      <a class="btn btn-dark btn-pill" href="{% url 'catalog:list' %}">Ir al catálogo</a>
    </div>
  {% endif %}
</div>

<script>
  const API_BASE = "{% url 'cart:item_api' 0 %}".replace("/0/", "/");

  function money2(v){
    const n = Number(v || 0);
    return n.toFixed(2);
  }

  function setCartBadge(n){
    const badge = document.getElementById("cartBadge");
    if(!badge) return;
    const val = parseInt(n || 0, 10);
    badge.textContent = val;
    badge.style.display = val > 0 ? "" : "none";
  }

  async function postForm(url, data){
    const formData = new FormData();
    Object.keys(data).forEach(k => formData.append(k, data[k]));

    const csrf = document.querySelector("input[name=csrfmiddlewaretoken]")?.value;
    if(csrf) formData.append("csrfmiddlewaretoken", csrf);

    const res = await fetch(url, {
      method: "POST",
      body: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });

    const json = await res.json();
    if(!res.ok) throw json;
    return json;
  }

  function setCheckoutEnabled(ok){
    const btn = document.getElementById("btnCheckout");
    if(!btn) return;
    btn.classList.toggle("disabled", !ok);
    btn.setAttribute("aria-disabled", ok ? "false" : "true");
  }

  function showErr(row, msg){
    const el = row.querySelector(".err");
    if(!el) return;
    if(msg){
      el.textContent = msg;
      el.classList.remove("d-none");
    }else{
      el.textContent = "";
      el.classList.add("d-none");
    }
  }

  async function updateItem(row, payload){
    const itemId = row.getAttribute("data-item-id");
    try{
      const data = await postForm(API_BASE + itemId + "/", payload);

      setCartBadge(data.cart_count);

      if(data.deleted){
        row.remove();
        document.getElementById("cartSubtotal").textContent = money2(data.cart_subtotal);

        if(data.items_left === 0){
          window.location.reload();
          return;
        }

        setCheckoutEnabled(data.can_checkout);
        return;
      }

      row.querySelector(".qty").value = data.item_qty;
      row.querySelector(".item-total").textContent = money2(data.item_total);
      row.querySelector(".stock").textContent = data.stock;
      document.getElementById("cartSubtotal").textContent = money2(data.cart_subtotal);
      setCheckoutEnabled(data.can_checkout);
      showErr(row, "");
    }catch(err){
      showErr(row, err?.error || "Error al actualizar");
      if(err?.stock !== undefined){
        row.querySelector(".stock").textContent = err.stock;
      }
    }
  }

  document.querySelectorAll("tr[data-item-id] .btn-qty").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const row = e.target.closest("tr[data-item-id]");
      const delta = btn.getAttribute("data-delta");
      await updateItem(row, { delta });
    });
  });

  document.querySelectorAll("tr[data-item-id] .qty").forEach(input => {
    input.addEventListener("change", async (e) => {
      const row = e.target.closest("tr[data-item-id]");
      let v = parseInt(input.value || "1", 10);
      if(isNaN(v) || v < 1) v = 1;
      await updateItem(row, { qty: v });
    });
  });
</script>
{% endblock %}
